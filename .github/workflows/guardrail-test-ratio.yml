name: "Guardrail: Test-to-Code Ratio"

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  checks: write
  pull-requests: read
  contents: read

jobs:
  test-ratio-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check test-to-code ratio
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');

            // --- Load configuration ---
            const configPath = '.github/agent-workflow/config.yaml';
            let threshold = 0.5;
            let enabled = true;
            let configuredConclusion = 'action_required';

            try {
              const configContent = fs.readFileSync(configPath, 'utf8');
              const config = yaml.load(configContent);
              const testRatioConfig = config?.guardrails?.['test-ratio'] || {};
              threshold = testRatioConfig.threshold ?? 0.5;
              enabled = testRatioConfig.enabled ?? true;
              configuredConclusion = testRatioConfig.conclusion ?? 'action_required';
            } catch (e) {
              core.info(`Could not read config from ${configPath}, using defaults: ${e.message}`);
            }

            if (!enabled) {
              core.info('Test-ratio guardrail is disabled in config. Skipping.');
              return;
            }

            // --- Get PR files ---
            const prNumber = context.payload.pull_request.number;
            const allFiles = [];
            let page = 1;
            while (true) {
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                per_page: 100,
                page: page,
              });
              allFiles.push(...files);
              if (files.length < 100) break;
              page++;
            }

            // --- Categorize files as test vs implementation ---
            // Test file patterns: *test*, *spec*, __tests__/
            function isTestFile(filename) {
              const lower = filename.toLowerCase();
              // Check for __tests__/ directory
              if (lower.includes('__tests__/')) return true;
              // Check for test/spec in filename (not directory names)
              const basename = lower.split('/').pop();
              if (basename.includes('test') || basename.includes('spec')) return true;
              // Check for test/spec directories like tests/, specs/
              const parts = lower.split('/');
              for (const part of parts) {
                if (part === 'tests' || part === 'specs' || part === 'test' || part === 'spec') return true;
              }
              return false;
            }

            // Ignore non-code files (config, docs, etc.)
            function isCodeFile(filename) {
              const codeExtensions = [
                '.js', '.jsx', '.ts', '.tsx', '.py', '.rb', '.go', '.rs',
                '.java', '.kt', '.scala', '.cs', '.cpp', '.c', '.h', '.hpp',
                '.swift', '.m', '.mm', '.php', '.lua', '.sh', '.bash',
                '.yml', '.yaml', '.json', '.toml', '.xml',
              ];
              const ext = '.' + filename.split('.').pop().toLowerCase();
              return codeExtensions.includes(ext);
            }

            let testLines = 0;
            let implLines = 0;
            const implFilesWithNoTests = [];

            for (const file of allFiles) {
              // Skip removed files
              if (file.status === 'removed') continue;
              // Skip non-code files
              if (!isCodeFile(file.filename)) continue;

              const additions = file.additions || 0;

              if (isTestFile(file.filename)) {
                testLines += additions;
              } else {
                implLines += additions;
                implFilesWithNoTests.push({
                  filename: file.filename,
                  additions: additions,
                });
              }
            }

            core.info(`Test lines added: ${testLines}`);
            core.info(`Implementation lines added: ${implLines}`);

            // --- Handle edge case: no implementation lines ---
            if (implLines === 0) {
              core.info('No implementation lines in this PR. Reporting success.');
              await github.rest.checks.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head_sha: context.payload.pull_request.head.sha,
                name: 'guardrail/test-ratio',
                status: 'completed',
                conclusion: 'success',
                output: {
                  title: 'Test-to-code ratio: no implementation changes',
                  summary: 'This PR contains no implementation line additions. Test ratio check is not applicable.',
                },
              });
              return;
            }

            // --- Calculate ratio ---
            const ratio = testLines / implLines;
            const passed = ratio >= threshold;

            core.info(`Test-to-code ratio: ${ratio.toFixed(2)} (threshold: ${threshold})`);

            // --- Check for non-stale PR approval override ---
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const headSha = context.payload.pull_request.head.sha;
            const hasValidApproval = reviews.some(
              (r) => r.state === 'APPROVED' && r.commit_id === headSha
            );

            // --- Determine conclusion ---
            let conclusion;
            let title;
            let summary;

            if (passed) {
              conclusion = 'success';
              title = `Test-to-code ratio: ${ratio.toFixed(2)} (threshold: ${threshold})`;
              summary = `PR has ${testLines} test lines and ${implLines} implementation lines added. Ratio ${ratio.toFixed(2)} meets the threshold of ${threshold}.`;
            } else if (hasValidApproval) {
              conclusion = 'success';
              title = `Test-to-code ratio: ${ratio.toFixed(2)} â€” approved by reviewer`;
              summary = `PR has ${testLines} test lines and ${implLines} implementation lines added. Ratio ${ratio.toFixed(2)} is below the threshold of ${threshold}, but a non-stale approval exists. Human has accepted the current state.`;
            } else {
              conclusion = configuredConclusion;
              title = `Test-to-code ratio: ${ratio.toFixed(2)} (threshold: ${threshold})`;
              summary = `PR has ${testLines} test lines and ${implLines} implementation lines added. Ratio ${ratio.toFixed(2)} is below the threshold of ${threshold}. Add more tests or approve the PR to override.`;
            }

            // --- Build annotations for implementation files lacking test coverage ---
            const annotations = [];
            if (!passed && !hasValidApproval) {
              for (const file of implFilesWithNoTests) {
                if (file.additions > 0) {
                  annotations.push({
                    path: file.filename,
                    start_line: 1,
                    end_line: 1,
                    annotation_level: 'warning',
                    message: `This implementation file has ${file.additions} added lines. The overall test-to-code ratio (${ratio.toFixed(2)}) is below the threshold (${threshold}). Consider adding corresponding tests.`,
                  });
                }
              }
            }

            // GitHub API limits annotations to 50 per request
            const truncatedAnnotations = annotations.slice(0, 50);

            // --- Report check run ---
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: headSha,
              name: 'guardrail/test-ratio',
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: title,
                summary: summary,
                annotations: truncatedAnnotations,
              },
            });

            core.info(`Check run created with conclusion: ${conclusion}`);
