name: PR Review

"on":
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      pr-number:
        description: "PR number to review (used by orchestrator for re-review)"
        required: true
        type: number

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # ── Resolve context shared by all reviewers ──────────────────────────
  resolve-context:
    runs-on: ubuntu-latest
    outputs:
      pr-number: ${{ steps.ctx.outputs.pr-number }}
      parent-issue: ${{ steps.ctx.outputs.parent-issue }}
      base-branch: ${{ steps.ctx.outputs.base-branch }}
      pr-title: ${{ steps.ctx.outputs.pr-title }}
    steps:
      - name: Resolve PR context
        id: ctx
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            let prData;

            if (context.eventName === 'workflow_dispatch') {
              prNumber = parseInt('${{ inputs.pr-number }}', 10);
              const { data } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });
              prData = data;
            } else {
              prNumber = context.payload.pull_request.number;
              prData = context.payload.pull_request;
            }

            // Parse "fixes #N" or "Fixes #N" from PR body
            const body = prData.body || '';
            const fixesMatch = body.match(/[Ff]ixes\s*#(\d+)/);
            const parentIssue = fixesMatch ? fixesMatch[1] : '';

            if (!parentIssue) {
              console.log('No parent issue found — PR body has no "Fixes #N" reference.');
            }

            core.setOutput('pr-number', prNumber.toString());
            core.setOutput('parent-issue', parentIssue);
            core.setOutput('base-branch', prData.base.ref);
            core.setOutput('pr-title', prData.title);

  # ── Correctness Reviewer ─────────────────────────────────────────────
  review-correctness:
    needs: resolve-context
    if: needs.resolve-context.outputs.parent-issue != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run correctness review
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            Read and follow .claude/skills/reviewer-correctness/SKILL.md

            Context:
            - Base branch: origin/${{ needs.resolve-context.outputs.base-branch }}
            - Parent issue: #${{ needs.resolve-context.outputs.parent-issue }}

            File findings as sub-issues of #${{ needs.resolve-context.outputs.parent-issue }}.
            See .claude/skills/github-issues/SKILL.md for the GraphQL patterns.
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # ── Tests Reviewer ───────────────────────────────────────────────────
  review-tests:
    needs: resolve-context
    if: needs.resolve-context.outputs.parent-issue != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run tests review
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            Read and follow .claude/skills/reviewer-tests/SKILL.md

            Context:
            - Base branch: origin/${{ needs.resolve-context.outputs.base-branch }}
            - Parent issue: #${{ needs.resolve-context.outputs.parent-issue }}

            File findings as sub-issues of #${{ needs.resolve-context.outputs.parent-issue }}.
            See .claude/skills/github-issues/SKILL.md for the GraphQL patterns.
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # ── Architecture Reviewer ────────────────────────────────────────────
  review-architecture:
    needs: resolve-context
    if: needs.resolve-context.outputs.parent-issue != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run architecture review
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            Read and follow .claude/skills/reviewer-architecture/SKILL.md

            Context:
            - Base branch: origin/${{ needs.resolve-context.outputs.base-branch }}
            - Parent issue: #${{ needs.resolve-context.outputs.parent-issue }}

            File findings as sub-issues of #${{ needs.resolve-context.outputs.parent-issue }}.
            See .claude/skills/github-issues/SKILL.md for the GraphQL patterns.
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
