name: PR Review

"on":
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      pr-number:
        description: "PR number to review (used by orchestrator for re-review)"
        required: true
        type: number

permissions:
  contents: read
  issues: write
  pull-requests: write
  id-token: write

jobs:
  # ── Resolve context shared by all reviewers ──────────────────────────
  resolve-context:
    runs-on: ubuntu-latest
    outputs:
      pr-number: ${{ steps.ctx.outputs.pr-number }}
      parent-issue: ${{ steps.ctx.outputs.parent-issue }}
      base-branch: ${{ steps.ctx.outputs.base-branch }}
      pr-title: ${{ steps.ctx.outputs.pr-title }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/agent-workflow

      - name: Resolve PR context
        id: ctx
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ inputs.pr-number }}
        with:
          script: |
            const run = require('./.github/agent-workflow/scripts/pr-context.js');
            await run({ github, context, core });

  # ── Correctness Reviewer ─────────────────────────────────────────────
  review-correctness:
    needs: resolve-context
    if: needs.resolve-context.outputs.parent-issue != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run correctness review
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            Read and follow .claude/skills/reviewer-correctness/SKILL.md

            Context:
            - Base branch: origin/${{ needs.resolve-context.outputs.base-branch }}
            - Parent issue: #${{ needs.resolve-context.outputs.parent-issue }}

            File findings as sub-issues of #${{ needs.resolve-context.outputs.parent-issue }}.
            See .claude/skills/github-issues/SKILL.md for the GraphQL patterns.
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  # ── Tests Reviewer ───────────────────────────────────────────────────
  review-tests:
    needs: resolve-context
    if: needs.resolve-context.outputs.parent-issue != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run tests review
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            Read and follow .claude/skills/reviewer-tests/SKILL.md

            Context:
            - Base branch: origin/${{ needs.resolve-context.outputs.base-branch }}
            - Parent issue: #${{ needs.resolve-context.outputs.parent-issue }}

            File findings as sub-issues of #${{ needs.resolve-context.outputs.parent-issue }}.
            See .claude/skills/github-issues/SKILL.md for the GraphQL patterns.
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  # ── Architecture Reviewer ────────────────────────────────────────────
  review-architecture:
    needs: resolve-context
    if: needs.resolve-context.outputs.parent-issue != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run architecture review
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            Read and follow .claude/skills/reviewer-architecture/SKILL.md

            Context:
            - Base branch: origin/${{ needs.resolve-context.outputs.base-branch }}
            - Parent issue: #${{ needs.resolve-context.outputs.parent-issue }}

            File findings as sub-issues of #${{ needs.resolve-context.outputs.parent-issue }}.
            See .claude/skills/github-issues/SKILL.md for the GraphQL patterns.
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
